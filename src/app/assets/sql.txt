create table if not exists users (  
id int primary key AUTO_INCREMENT,
name varchar(30) NOT NULL UNIQUE,
password varchar(50) NOT NULL,
createAt TIMESTAMP DEFAULT   CURRENT_TIMESTAMP,
updateAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)

create table if not exists moments (
id INT PRIMARY KEY AUTO_INCREMENT,
content VARCHAR(1000) NOT NULL,
user_id INT NOT NULL,
createAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updateAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
FOREIGN KEY (user_id) REFERENCES users(id)
 )

/* 
获取动态详情，需要包含评论列表。 可以将评论和动态数据分为两个接口分开返回也可以将评论和动态直接揉在一个接口返回
**/
//单独返回
SELECT m.id id, m.content content, m.createAt createTime, m.updateAt updateTime,JSON_OBJECT('id',u.id
,'name',u.name) user FROM moments m  LEFT JOIN users u ON m.user_id  = u.id WHERE m.id = ?
//合并返回
SELECT m.id id, m.content content, m.createAt createTime, m.updateAt updateTime
,JSON_OBJECT('id',u.id,'name',u.name) user, 
JSON_ARRAYAGG(JSON_OBJECT('id',c.id,'content',c.content,'commentId',c.comment_id,'createTime',c.createAt,'updateTime',c.updateAt
,'user',JSON_OBJECT('id',cu.id,'name',cu.name))) commentList 
 FROM moments m  
 LEFT JOIN users u ON m.user_id  = u.id
 LEFT JOIN comments c ON c.moment_id  = m.id 
 LEFT JOIN users cu ON c.user_id  = cu.id
 WHERE m.id = ?
 GROUP BY m.id, m.content, m.createAt, m.updateAt, u.id, u.name

SELECT m.id id, m.content content, m.createAt createTime, m.updateAt updateTime,JSON_OBJECT('id',u.id
,'name',u.name) user,(SELECT COUNT(*) FROM comments WHERE comments.moment_id = m.id) commentCount FROM moments m  LEFT JOIN users u ON m.user_id  = u.id LIMIT ? , ?


UPDATE moments SET content = ? WHERE id = ?

DELETE FROM moments WHERE id = ?




create table if not exists comments (
id INT PRIMARY KEY AUTO_INCREMENT,
content VARCHAR(1000) NOT NULL,
user_id INT NOT NULL,
moment_id INT NOT NULL,
comment_id INT DEFAULT NULL,
createAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updateAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (moment_id) REFERENCES moments(id)  ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (comment_id) REFERENCES comments(id)  ON DELETE CASCADE ON UPDATE CASCADE
 );

 SELECT c.id, c.content, c.updateAt updateTime, c.createAt createTime,
          JSON_OBJECT('id',u.id,'name',u.name) user
          FROM comments c 
          LEFT JOIN users u ON u.id = c.user_id
          WHERE  c.moment_id = ?  LIMIT ? , ?


CREATE TABLE IF NOT EXISTS labels (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(10) NOT NULL UNIQUE,
    createAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updateAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
CREATE TABLE IF NOT EXISTS moment_labels (
    label_id INT NOT NULL,
    moment_id INT NOT NULL,
    createAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updateAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY(moment_id,label_id),
    FOREIGN KEY (label_id) REFERENCES labels(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (moment_id) REFERENCES moments(id) ON DELETE CASCADE ON UPDATE CASCADE
)
